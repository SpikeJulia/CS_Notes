## InnoDB - 表

### 1、索引组织表

* 根据主键顺序组织存放的叫索引组织表；
* InnoDB存储引擎表中，必有主键；创建表时，没有显示定义，会自动选择或创建主键：
  * 表中是否有非空的唯一索引，有则为主键；
  * 否则，自动创建一个6字节大小的指针为主键。
* 查看主键命令：SELECT a,b,c,_rowid FROM z;  abc为列名，__rowid 为查询的主键列

***

### 2、InnoDB 逻辑存储结构

* 所有数据都被逻辑地存放再一个表空间中，表空间由 段(segment)、区(extent)、页(page)组成；
* ![](存储结构.png)

***

***

### 2.1、表空间

* 表空间是InnoDB存储引擎逻辑结构最高层，所有数据都放在表空间中；
* 默认情况下有一个共享的表空间——ibdata1,  所有数据都放在其中；
* 启用 innodb_file_per_table，则每张表内的数据都单独存放到一个表空间，仅是数据、索引和插入缓冲Bitmap页；
* 其他类数据，如回滚信息，插入缓冲索引页，系统事务信息，二次写缓冲等还是在 ibdata1中。

***

### 2.2、段

* 数据段：B+树的叶子节点
* 索引段：B+树的非叶子节点
* 回滚段

***

### 2.3、区

* 区是连续的页构成，任何情况大小为 1M
* 默认页大小为16k，即一个区有64个连续的页
* 引入压缩页后，2、4、8K大小

***

### 2.4、页

* 默认大小16K
* 数据页(B-tree Node)
* undo页(undo Log Page)
* 系统页(System Page)
* 事务数据页(Transaction system Page)
* 插入缓冲位图页(Insert Buffer Free List)
* 插入缓冲空闲列表页(Insert Buffer Free List)
* 未压缩的二进制大对象页(Uncompressed BLOB Page)
* 压缩的二进制大对象页(compressed BLOB Page)

***

### 2.5、行

* InnoDB面向列的，数据按行存放
* 每页存放行记录有限制，最多(16KB/ 2byte)-200 = 7992行
* 200行为预留行数

***

### 2.6、行记录格式

#### 2.6.1 Compact 格式

*  目前使用最多的格式，一个页中行数据越多，性能越高

* 首部是一个非NULL边长字段长度列表，按照列的逆序放置：
  * 若列长度小于255字节，用1字节表示；
  * 大于则用2字节，最大不可超过2字节，因为VARCHAR类型的最大长度限制为65535；

* NULL标志位标识是否有NULL值，NULL只占标志位，不占用其他空间；
* 两个隐藏列：事物ID列(6字节)和回滚指针列(7字节)；

| 1-2字节 | 1字节 | 5字节 |         |         |        |
| :----------: | :-------: | :--------: | :-----: | :-----: | ------ |
| 变长字段长度列表 | NULL标志位 | 记录头信息 | 列1数据 | 列2数据 | ...... |



#### 2.6.2 Redundant 格式

* MYSQL5.0之前的记录存储方式，兼容之前版本的页格式；

#### 2.6.3 行溢出数据

InnoDB会将一条记录种的某些数据存储在真正的数据页之外；

* 并不支持 65535长度的 VARCHAR 类型，因为还有别的开销；
* 实测最大能存放的最大长度为 65532，但数据库会自动将VARCHAR转为TEXT类型；

**重点：**

* VARCHAR(N), N指的是字符的长度；
* 而文档说的最大支持 65535指的是字节；
* 另外，65535指的是所有VARCHAR列的长度总和；
* InnoDB行保存VARCHAR的前768字节，之后偏移量指向行溢出页-BLOB page。

**行溢出：**

* InnoDB 引擎的数据一般都是存放在页类型为 B-tree node中；
* 行溢出时，数据存放在页类型为 Uncompress BLOB页中;
* VARCHAR类型的行数据放到BLOB页的阈值为VARCHAR(8098)。

#### 2.6.4 Compressed和Dynamic行记录格式

* InnoDB 1.0.x版本引入的新的页格式；
* 对于存放在BLOB中的数据采用了完全的行溢出的方式；
* 数据页只存放20个字节的指针，实际的苏剧都存放在Off Page页中。

#### 2.6.5 CHAR 的行结构存储

* 通常理解VARCHAR是存储变长长度的字符类型，CHAR是存储定长长度的字符类型；
* MYSQL 4.1版本开始，CHR(N) N指的是字符的长度，而不是之前的字节长度；
* 所以在不同的字符集下，CHAR类型的内部存储可能不是定长的数据；

***

### 3、InnoDB 数据页结构

**组成结构：**

* File Headers - 文件头
* Page Headers - 页头
* Infimun 和 Superemum Records
* User Records- 行记录
* Free Space - 空闲空间
* Page Directory - 页目录
* File Trailer - 文件结尾信息